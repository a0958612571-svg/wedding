<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å©šç¦®æ’åº§åŠ©æ‰‹ - å°ˆæ¥­å–®æ©Ÿç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .canvas-bg { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .table-circle { transition: all 0.2s; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .table-circle:hover { transform: scale(1.05); border-color: #6366f1; }
        .selected-guest { border: 2px solid #4f46e5 !important; background-color: #eef2ff !important; box-shadow: 0 0 10px rgba(79, 70, 229, 0.2); }
        .aisle-text { writing-mode: vertical-lr; letter-spacing: 0.8em; opacity: 0.3; }
        .group-label { font-size: 10px; color: #94a3b8; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-20">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-black text-indigo-600 tracking-tighter">WEDDING SEATING</h1>
            <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold">V3.5 OFFLINE</span>
        </div>
        <div class="flex gap-2">
            <button onclick="addNewTable()" class="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-indigo-100 border border-indigo-200">ï¼‹æ–°å¢ä¸€æ¡Œ</button>
            <button onclick="toggleModal('guest-modal')" class="bg-white border px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-slate-50">ï¼‹ç®¡ç†è³“å®¢</button>
            <button onclick="generateExportData()" class="bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700">ğŸ“Š åŒ¯å‡ºå ±å‘Š</button>
            <button onclick="resetApp()" class="text-red-400 hover:text-red-600 text-xs px-2 font-bold">âš ï¸ é‡ç½®</button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        <aside class="w-64 bg-white border-r flex flex-col shadow-lg">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <span class="font-bold text-xs uppercase text-slate-500">å¾…åˆ†é…è³“å®¢</span>
                <span id="unassigned-count" class="bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full font-black">0</span>
            </div>
            <div id="guest-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
        </aside>

        <section class="flex-1 relative canvas-bg bg-slate-100 p-8 overflow-auto">
            <div id="table-canvas" class="flex flex-col items-center min-w-[1000px]">
                
                <div class="w-full flex flex-col items-center mb-12">
                    <div class="bg-slate-800 text-white px-12 py-1.5 rounded-b-xl mb-10 text-[10px] font-black tracking-[0.5em] uppercase shadow-lg">STAGE èˆå°ä¸­å¿ƒ</div>
                    <div id="main-table-container"></div>
                </div>

                <div class="flex justify-center gap-12">
                    <div class="flex flex-col items-center">
                        <div class="group-label mb-4">å·¦å´å‰æ–¹ (1-6)</div>
                        <div id="left-6" class="grid grid-cols-2 gap-6 p-4 bg-slate-200/30 rounded-2xl"></div>
                        <div class="h-16 flex items-center justify-center italic text-slate-300 font-bold text-xs">â”€â”€ èµ°é“ â”€â”€</div>
                        <div class="group-label mb-4">å·¦å´å¾Œæ–¹</div>
                        <div id="left-extra" class="grid grid-cols-2 gap-6 p-4 bg-slate-200/30 rounded-2xl min-h-[100px] min-w-[200px]"></div>
                    </div>

                    <div class="flex flex-col items-center pt-20">
                        <div class="aisle-text text-slate-300 font-black text-sm uppercase opacity-50">ç´…æ¯¯èµ°é“ RED CARPET</div>
                    </div>

                    <div class="flex flex-col items-center">
                        <div class="group-label mb-4">å³å´å‰æ–¹ (1-6)</div>
                        <div id="right-6" class="grid grid-cols-2 gap-6 p-4 bg-slate-200/30 rounded-2xl"></div>
                        <div class="h-16 flex items-center justify-center italic text-slate-300 font-bold text-xs">â”€â”€ èµ°é“ â”€â”€</div>
                        <div class="group-label mb-4">å³å´å¾Œæ–¹</div>
                        <div id="right-extra" class="grid grid-cols-2 gap-6 p-4 bg-slate-200/30 rounded-2xl min-h-[100px] min-w-[200px]"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="guest-modal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-6 text-left">
            <h3 class="font-bold mb-4 text-indigo-600 uppercase tracking-widest italic">Import Guests</h3>
            <textarea id="guest-input" rows="8" class="w-full border p-4 rounded-xl text-sm bg-slate-50 outline-none focus:ring-2 ring-indigo-500" placeholder="å§“åï¼Œä¸€äººä¸€è¡Œ..."></textarea>
            <div class="flex justify-end mt-4 gap-2">
                <button onclick="toggleModal('guest-modal')" class="text-slate-400 font-bold px-4">å–æ¶ˆ</button>
                <button onclick="addGuests()" class="bg-indigo-600 text-white px-8 py-2 rounded-xl font-bold">åŠ å…¥åå–®</button>
            </div>
        </div>
    </div>

    <div id="detail-modal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-[350px] p-6 text-center">
            <h3 id="dt-name" class="font-black text-xl mb-4 text-indigo-600"></h3>
            <div id="dt-list" class="space-y-2 mb-6 max-h-64 overflow-y-auto text-left"></div>
            <div id="dt-delete-area" class="border-t pt-4"></div>
            <button onclick="toggleModal('detail-modal')" class="w-full bg-slate-100 py-2 rounded-xl mt-4 font-bold text-xs">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <div id="export-modal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-[500px] p-6 text-left">
            <h3 class="font-bold mb-4 text-indigo-600">ğŸ“Š æœ€çµ‚æ’åº§æ¸…å–®</h3>
            <textarea id="export-text" rows="12" class="w-full border p-3 rounded-xl text-xs font-mono bg-slate-50 mb-4 outline-none" readonly></textarea>
            <div class="flex gap-2">
                <button onclick="copyExport()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl font-bold">è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
                <button onclick="toggleModal('export-modal')" class="px-6 bg-slate-100 rounded-xl font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        let guests = [];
        let tables = [];
        let selectedId = null;
        const KEY = 'WEDDING_V3_5_FINAL';

        function toggleModal(id) { document.getElementById(id).classList.toggle('active'); }

        // è‡ªå‹•é‡æ–°ç·¨è™Ÿé‚è¼¯
        function reorderTables() {
            let count = 1;
            tables.forEach(t => {
                if (t.id !== 'main') {
                    t.name = `ç¬¬ ${count} æ¡Œ`;
                    // 6+4 ä½ˆå±€é‚è¼¯
                    if (count <= 6) t.section = 'L6';
                    else if (count <= 12) t.section = 'R6';
                    else if (count % 2 !== 0) t.section = 'LE'; // å·¦å¾Œ
                    else t.section = 'RE'; // å³å¾Œ
                    count++;
                }
            });
        }

        function initTables() {
            tables = [{ id: 'main', name: "ğŸ‘‘ ä¸»æ¡Œ", cap: 12, list: [], section: 'main' }];
            for (let i = 1; i <= 20; i++) {
                tables.push({ id: 't' + Date.now() + i, name: '', cap: 10, list: [], section: '' });
            }
            reorderTables();
        }

        function addNewTable() {
            tables.push({ id: 't' + Date.now(), name: "", cap: 10, list: [], section: '' });
            reorderTables();
            render();
        }

        function deleteTable(tid) {
            if (tid === 'main') return alert("ä¸»æ¡Œä¸èƒ½åˆªé™¤ï¼");
            if (confirm("ç¢ºå®šåˆªé™¤æ­¤æ¡Œï¼Ÿæ¡Œå…§è³“å®¢å°‡å›åˆ°å¾…åˆ†é…åå–®ã€‚")) {
                const idx = tables.findIndex(x => x.id === tid);
                tables[idx].list.forEach(g => {
                    const originalGuest = guests.find(x => x.id === g.id);
                    if(originalGuest) originalGuest.tId = null;
                });
                tables.splice(idx, 1);
                reorderTables();
                toggleModal('detail-modal');
                render();
            }
        }

        function addGuests() {
            const input = document.getElementById('guest-input');
            const lines = input.value.split('\n').filter(n => n.trim());
            lines.forEach(name => {
                guests.push({ id: Math.random(), name: name.trim(), tId: null });
            });
            input.value = '';
            toggleModal('guest-modal');
            render();
        }

        function render() {
            // è³“å®¢æ¸…å–®
            const gList = document.getElementById('guest-list');
            const unassigned = guests.filter(g => !g.tId);
            gList.innerHTML = unassigned.map(g => `
                <div onclick="selectGuest(${g.id})" class="p-3 bg-white border rounded-xl cursor-pointer text-sm font-bold shadow-sm transition-all ${selectedId === g.id ? 'selected-guest' : 'hover:border-indigo-200'}">
                    ${g.name}
                </div>
            `).join('') || '<div class="py-10 text-center text-slate-300 text-xs italic">åå–®å·²æ¸…ç©º</div>';
            
            document.getElementById('unassigned-count').innerText = unassigned.length;

            // æ¸…ç©ºç•«å¸ƒå®¹å™¨
            ['main-table-container','left-6','left-extra','right-6','right-extra'].forEach(id => document.getElementById(id).innerHTML = '');

            // æ¸²æŸ“æ¡Œä½
            tables.forEach(t => {
                const div = document.createElement('div');
                div.className = `table-circle w-28 h-28 rounded-full bg-white flex flex-col items-center justify-center cursor-pointer relative ${t.section === 'main' ? 'w-36 h-36 border-amber-400 bg-amber-50' : 'border-slate-100'}`;
                div.innerHTML = `
                    <span class="text-[8px] font-black text-slate-300 uppercase">${t.name}</span>
                    <span class="text-lg font-black text-slate-700">${t.list.length}<span class="text-xs text-slate-300">/${t.cap}</span></span>
                    <div class="text-[7px] text-slate-400 font-bold truncate w-20 text-center px-1">${t.list.map(x=>x.name).join(',')}</div>
                `;
                div.onclick = () => handleTable(t.id);

                const containerId = { 'main': 'main-table-container', 'L6': 'left-6', 'LE': 'left-extra', 'R6': 'right-6', 'RE': 'right-extra' }[t.section];
                if(containerId) document.getElementById(containerId).appendChild(div);
            });

            localStorage.setItem(KEY, JSON.stringify({ guests, tables }));
        }

        function selectGuest(id) {
            selectedId = (selectedId === id ? null : id);
            render();
        }

        function handleTable(tid) {
            const t = tables.find(x => x.id === tid);
            if (selectedId) {
                const g = guests.find(x => x.id === selectedId);
                if (t.list.length < t.cap) {
                    t.list.push({ id: g.id, name: g.name });
                    g.tId = tid;
                    selectedId = null;
                    render();
                } else alert("é€™æ¡Œå·²ç¶“å®¢æ»¿å›‰ï¼");
            } else {
                document.getElementById('dt-name').innerText = t.name;
                const listEl = document.getElementById('dt-list');
                listEl.innerHTML = t.list.map(g => `
                    <div class="flex justify-between items-center p-2.5 bg-slate-50 rounded-xl mb-1 text-sm border border-slate-100">
                        <span class="font-bold text-slate-700">${g.name}</span>
                        <button onclick="removeG('${t.id}', ${g.id})" class="text-red-400 font-bold hover:text-red-600">ç§»é™¤</button>
                    </div>
                `).join('') || '<p class="text-center text-slate-300 py-6 text-xs">ç©ºæ¡Œ</p>';
                
                document.getElementById('dt-delete-area').innerHTML = t.id !== 'main' ? `
                    <button onclick="deleteTable('${t.id}')" class="text-red-400 text-[10px] font-bold hover:underline">ğŸ—‘ï¸ åˆªé™¤æ­¤æ¡Œä¸¦é‡æ–°ç·¨è™Ÿ</button>
                ` : '';
                toggleModal('detail-modal');
            }
        }

        function removeG(tid, gid) {
            const t = tables.find(x => x.id === tid);
            t.list = t.list.filter(x => x.id !== gid);
            const g = guests.find(x => x.id === gid);
            if(g) g.tId = null;
            toggleModal('detail-modal');
            render();
        }

        function generateExportData() {
            let res = "ã€å©šç¦®åº§ä½åˆ†é…æœ€çµ‚å ±å‘Šã€‘\n";
            res += "========================\n\n";
            tables.forEach(t => {
                res += `${t.name} (${t.list.length}/${t.cap}äºº)ï¼š\n`;
                res += t.list.length ? t.list.map(x=>x.name).join('ã€') : '(ç„¡äººå…¥åº§)';
                res += "\n\n";
            });
            document.getElementById('export-text').value = res;
            toggleModal('export-modal');
        }

        function copyExport() {
            const el = document.getElementById('export-text');
            el.select();
            document.execCommand('copy');
            alert('å…§å®¹å·²è¤‡è£½ï¼');
        }

        function resetApp() {
            if(confirm("é€™å°‡æœƒæ¸…é™¤æ‰€æœ‰è³“å®¢èˆ‡æ¡Œä½è³‡æ–™ï¼ç¢ºå®šå—ï¼Ÿ")) {
                localStorage.removeItem(KEY);
                location.reload();
            }
        }

        window.onload = () => {
            const saved = localStorage.getItem(KEY);
            if (saved) {
                const p = JSON.parse(saved);
                guests = p.guests;
                tables = p.tables;
            } else {
                initTables();
            }
            render();
        };
    </script>
</body>
</html>
