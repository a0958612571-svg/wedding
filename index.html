<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å©šç¦®æ’åº§ - æ¨™ç±¤çµ±è¨ˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .canvas-bg { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .table-circle { transition: all 0.2s; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .selected-guest { border: 2px solid #4f46e5 !important; background-color: #eef2ff !important; }
        .tag-v { background-color: #dcfce7; color: #166534; } /* ç´ é£Ÿ */
        .tag-m { background-color: #fee2e2; color: #991b1b; } /* ç”·æ–¹ */
        .tag-f { background-color: #f0f9ff; color: #075985; } /* å¥³æ–¹ */
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-800 font-sans">

    <header class="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-20">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-black text-indigo-600 italic">WEDDING</h1>
            <span class="bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-widest">Tag & Stats</span>
        </div>
        <div class="flex gap-2">
            <button onclick="addNewTable()" class="bg-white border border-indigo-200 text-indigo-600 px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-indigo-50 transition">ï¼‹æ–°å¢æ¡Œæ¬¡</button>
            <button onclick="toggleModal('guest-modal')" class="bg-white border px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-slate-50 transition">ï¼‹æ‰¹é‡åŒ¯å…¥</button>
            <button onclick="generateExportData()" class="bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700 transition">ğŸ“Š åŒ¯å‡ºå ±å‘Š</button>
            <button onclick="resetApp()" class="text-red-400 text-xs px-2 font-bold hover:text-red-600 transition">é‡ç½®</button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        <aside class="w-72 bg-white border-r flex flex-col shadow-lg z-10">
            <div class="p-4 border-b bg-slate-50">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-xs uppercase text-slate-500 italic">Unassigned (<span id="unassigned-count">0</span>)</span>
                </div>
                <div class="flex gap-1 flex-wrap">
                    <span class="text-[9px] px-1.5 py-0.5 rounded bg-green-100 text-green-700 font-bold">åŠ  (ç´ ) å­—è‡ªå‹•æ¨™è¨˜</span>
                </div>
            </div>
            <div id="guest-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
        </aside>

        <section class="flex-1 relative canvas-bg bg-slate-100 overflow-auto">
            <div class="min-w-[1100px] py-12 flex flex-col items-center">
                
                <div class="w-full flex flex-col items-center mb-16">
                    <div class="bg-slate-800 text-white px-20 py-1.5 rounded-b-2xl mb-12 text-[10px] font-black tracking-[1em] uppercase shadow-xl">STAGE èˆå°ä¸­å¿ƒ</div>
                    <div id="main-table-container"></div>
                </div>

                <div class="flex justify-center items-start gap-20">
                    <div class="w-[320px] flex flex-col items-center">
                        <div id="left-6" class="grid grid-cols-2 gap-8 p-6 bg-white/40 border-2 border-dashed border-slate-200 rounded-[2rem]"></div>
                        <div class="h-16 flex items-center justify-center italic text-slate-300 font-bold text-[10px] tracking-[0.5em] uppercase">Side Aisle</div>
                        <div id="left-extra" class="grid grid-cols-2 gap-8 p-6 bg-white/40 border-2 border-dashed border-slate-200 rounded-[2rem] min-h-[140px]"></div>
                    </div>
                    <div class="flex flex-col items-center pt-24"><div class="writing-vertical text-slate-300 font-black text-xs uppercase tracking-[1em] opacity-40" style="writing-mode: vertical-lr;">RED CARPET</div></div>
                    <div class="w-[320px] flex flex-col items-center">
                        <div id="right-6" class="grid grid-cols-2 gap-8 p-6 bg-white/40 border-2 border-dashed border-slate-200 rounded-[2rem]"></div>
                        <div class="h-16 flex items-center justify-center italic text-slate-300 font-bold text-[10px] tracking-[0.5em] uppercase">Side Aisle</div>
                        <div id="right-extra" class="grid grid-cols-2 gap-8 p-6 bg-white/40 border-2 border-dashed border-slate-200 rounded-[2rem] min-h-[140px]"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="detail-modal" class="modal"><div class="bg-white rounded-3xl shadow-2xl w-[380px] p-8 text-center">
        <div class="flex items-center justify-center gap-3 mb-2">
            <h3 id="dt-name" class="font-black text-2xl text-indigo-600 tracking-tighter"></h3>
            <button onclick="editTableName()" class="text-slate-300 hover:text-indigo-600 text-xs">âœï¸</button>
        </div>
        <div id="dt-stats" class="mb-6 flex justify-center gap-2"></div> <div id="dt-list" class="space-y-2 mb-8 max-h-72 overflow-y-auto px-1 text-left"></div>
        <div id="dt-delete-area"></div>
        <button onclick="toggleModal('detail-modal')" class="w-full bg-slate-100 text-slate-500 py-3 rounded-2xl mt-4 font-bold text-xs uppercase tracking-widest hover:bg-slate-200 transition">Close</button>
    </div></div>

    <div id="guest-modal" class="modal"><div class="bg-white rounded-3xl shadow-2xl w-[400px] p-8">
        <h3 class="font-black mb-2 text-indigo-600 italic">BATCH IMPORT</h3>
        <p class="text-[10px] text-slate-400 mb-4">æç¤ºï¼šå§“åå¾ŒåŠ  (ç´ ) å¯è‡ªå‹•æ¨™è¨˜ç´ é£Ÿè€…ã€‚</p>
        <textarea id="guest-input" rows="8" class="w-full border-2 border-slate-100 p-4 rounded-2xl text-sm bg-slate-50 outline-none focus:border-indigo-500" placeholder="ç‹å°æ˜ (ç´ )&#10;æå¤§è¯&#10;..."></textarea>
        <div class="flex justify-end mt-6 gap-3"><button onclick="toggleModal('guest-modal')" class="font-bold text-slate-400 px-4">å–æ¶ˆ</button><button onclick="addGuests()" class="bg-indigo-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg">åŒ¯å…¥</button></div>
    </div></div>

    <script>
        let guests = [];
        let tables = [];
        let selectedId = null;
        let currentEditingTid = null;
        const KEY = 'WEDDING_V3_9_TAGS';

        function toggleModal(id) { document.getElementById(id).classList.toggle('active'); }

        function reorderTables() {
            let guestTables = tables.filter(t => t.id !== 'main');
            const mid = Math.ceil(guestTables.length / 2);
            guestTables.forEach((t, i) => {
                const num = i + 1;
                t.name = t.customName || `ç¬¬ ${num} æ¡Œ`;
                if (num <= mid) { t.section = (num <= 6) ? 'L6' : 'LE'; } 
                else { const rIdx = num - mid; t.section = (rIdx <= 6) ? 'R6' : 'RE'; }
            });
        }

        function render() {
            const gList = document.getElementById('guest-list');
            const unassigned = guests.filter(g => !g.tId);
            gList.innerHTML = unassigned.map(g => `
                <div onclick="selectedId=(selectedId===${g.id}?null:${g.id});render();" class="p-3 bg-white border-2 rounded-xl cursor-pointer text-sm font-bold flex justify-between items-center transition-all ${selectedId===g.id?'selected-guest border-indigo-500 shadow-md':'border-transparent hover:border-slate-100'}">
                    <span>${g.name}</span>
                    ${g.isVeg ? '<span class="text-[9px] px-1.5 py-0.5 rounded bg-green-100 text-green-700 font-bold">ç´ </span>' : ''}
                </div>
            `).join('') || '<div class="py-10 text-center text-slate-300 text-xs italic">åå–®ç©ºç©ºå¦‚ä¹Ÿ</div>';
            
            document.getElementById('unassigned-count').innerText = unassigned.length;
            ['main-table-container','left-6','left-extra','right-6','right-extra'].forEach(id => document.getElementById(id).innerHTML = '');

            tables.forEach(t => {
                const vegCount = t.list.filter(gid => guests.find(g => g.id === gid.id)?.isVeg).length;
                const div = document.createElement('div');
                div.className = `table-circle w-28 h-28 rounded-full bg-white flex flex-col items-center justify-center cursor-pointer relative ${t.section === 'main' ? 'w-40 h-40 border-amber-400 bg-amber-50 shadow-amber-100 shadow-xl' : 'border-slate-50'}`;
                div.innerHTML = `
                    <span class="text-[8px] font-black text-slate-300 uppercase mb-1 truncate w-20 text-center">${t.name}</span>
                    <span class="text-xl font-black text-slate-800">${t.list.length}<span class="text-[10px] text-slate-300">/${t.cap}</span></span>
                    ${vegCount > 0 ? `<span class="text-[8px] mt-1 text-green-600 font-bold">ğŸƒ ç´ é£Ÿ ${vegCount}</span>` : ''}
                `;
                div.onclick = () => handleTable(t.id);
                const cid = { 'main':'main-table-container','L6':'left-6','LE':'left-extra','R6':'right-6','RE':'right-extra' }[t.section];
                if(cid) document.getElementById(cid).appendChild(div);
            });
            localStorage.setItem(KEY, JSON.stringify({ guests, tables }));
        }

        function handleTable(tid) {
            const t = tables.find(x => x.id === tid);
            if (selectedId) {
                const g = guests.find(x => x.id === selectedId);
                if (t.list.length < t.cap) { t.list.push({id:g.id}); g.tId = tid; selectedId = null; render(); }
            } else {
                currentEditingTid = tid;
                document.getElementById('dt-name').innerText = t.name;
                const tableGuests = t.list.map(obj => guests.find(g => g.id === obj.id));
                const vegCount = tableGuests.filter(g => g.isVeg).length;
                
                document.getElementById('dt-stats').innerHTML = `
                    <span class="text-[10px] px-2 py-1 rounded-full bg-slate-100 text-slate-500 font-bold">å…± ${t.list.length} äºº</span>
                    ${vegCount > 0 ? `<span class="text-[10px] px-2 py-1 rounded-full bg-green-100 text-green-700 font-bold">ç´ é£Ÿ ${vegCount} äºº</span>` : ''}
                `;

                document.getElementById('dt-list').innerHTML = tableGuests.map(g => `
                    <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl mb-1.5 border border-slate-100">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-slate-700">${g.name}</span>
                            ${g.isVeg ? '<span class="text-[9px] px-1.5 py-0.5 rounded bg-green-500 text-white font-black scale-90">ç´ </span>' : ''}
                        </div>
                        <button onclick="removeG('${t.id}',${g.id})" class="text-red-400 text-[10px] font-black hover:text-red-600">REMOVE</button>
                    </div>
                `).join('') || '<p class="text-center text-slate-300 py-6 text-xs italic font-serif">Empty Table</p>';
                
                document.getElementById('dt-delete-area').innerHTML = t.id !== 'main' ? `<button onclick="deleteTable('${t.id}')" class="text-red-300 text-[9px] font-bold hover:text-red-500 transition">ğŸ—‘ï¸ åˆªé™¤æ­¤æ¡Œ</button>` : '';
                toggleModal('detail-modal');
            }
        }

        function addGuests() {
            const input = document.getElementById('guest-input');
            input.value.split('\n').filter(n=>n.trim()).forEach(rawName => {
                const isVeg = rawName.includes('(ç´ )') || rawName.includes('ç´ é£Ÿ');
                const name = rawName.replace('(ç´ )', '').replace('ç´ é£Ÿ', '').trim();
                guests.push({ id: Math.random(), name, tId: null, isVeg });
            });
            input.value = ''; toggleModal('guest-modal'); render();
        }

        // --- å…¶ä»–è¼”åŠ©å‡½å¼ä¿æŒä¸è®Š ---
        function editTableName() {
            const t = tables.find(x => x.id === currentEditingTid);
            const name = prompt("ä¿®æ”¹æ¡Œæ¬¡åç¨±ï¼š", t.name);
            if (name) { t.customName = name; t.name = name; render(); document.getElementById('dt-name').innerText = name; }
        }
        function removeG(tid, gid) {
            const t = tables.find(x => x.id === tid);
            t.list = t.list.filter(obj => obj.id !== gid);
            guests.find(g => g.id === gid).tId = null;
            handleTable(tid); render();
        }
        function addNewTable() { tables.push({ id: 't'+Date.now(), name: "", cap: 10, list: [], section: '', customName: null }); reorderTables(); render(); }
        function deleteTable(tid) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")){ const idx=tables.findIndex(x=>x.id===tid); tables[idx].list.forEach(o=>guests.find(g=>g.id===o.id).tId=null); tables.splice(idx,1); reorderTables(); toggleModal('detail-modal'); render(); } }
        function generateExportData() {
            let res = "ã€å©šç¦®æ’åº§å ±å‘Š - é£Ÿæ€§çµ±è¨ˆã€‘\n\n";
            tables.forEach(t => {
                const tableGuests = t.list.map(obj => guests.find(g => g.id === obj.id));
                const vegCount = tableGuests.filter(g => g.isVeg).length;
                res += `${t.name} (å…±${t.list.length}äºº / ç´ é£Ÿ${vegCount}äºº): \n`;
                res += tableGuests.map(g => g.name + (g.isVeg?'(ç´ )':'')).join('ã€') || '(ç©º)';
                res += "\n\n";
            });
            document.getElementById('export-text').value = res;
            toggleModal('export-modal');
        }
        function resetApp() { if(confirm("é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.removeItem(KEY); location.reload(); } }
        function initTables() {
            tables = [{ id: 'main', name: "ğŸ‘‘ ä¸»æ¡Œ", cap: 12, list: [], section: 'main', customName: "ğŸ‘‘ ä¸»æ¡Œ" }];
            for (let i = 1; i <= 20; i++) tables.push({ id: 't' + Date.now() + i, name: '', cap: 10, list: [], section: '', customName: null });
            reorderTables();
        }
        window.onload = () => {
            const saved = localStorage.getItem(KEY);
            if (saved) { const p = JSON.parse(saved); guests = p.guests; tables = p.tables; } else initTables();
            render();
        };
    </script>
</body>
</html>
